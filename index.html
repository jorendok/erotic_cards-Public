<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜¥é–¨æˆ²å¯†åœ– | å¤é¢¨æƒ…è¶£å¡ç‰Œ</title>
    <style>
        :root { --gold: #d4af37; --bg: #0a0a0a; --dark-grey: #1a1a1a; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Noto Serif TC', serif; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }

        /* 18æ­²è­¦ç¤ºçª— */
        #age-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; transition: opacity 0.6s; }
        .gate-box { text-align: center; padding: 40px 25px; border: 1px solid var(--gold); background: #0d0d0d; border-radius: 20px; width: 85%; max-width: 400px; box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); }
        
        /* éŠæˆ²ä¸»å®¹å™¨ */
        .card-container { position: relative; height: 75vh; aspect-ratio: 472 / 945; perspective: 1200px; opacity: 0; transition: opacity 1s; }
        .card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .card.is-flipped { transform: rotateY(180deg); }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background-size: cover; background-position: center; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #222; }
        .face-front { transform: rotateY(180deg); }
        
        /* å°é¢æ»‘å…¥æ•ˆæœ */
        #card-back.slide-in { animation: slideFromTop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideFromTop {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(0); }
        }

        /* UI æŒ‰éˆ•å€ */
        .ui-layer { position: absolute; bottom: 8%; left: 0; width: 100%; display: none; flex-direction: column; align-items: center; z-index: 10; pointer-events: none; }
        .btn { 
            pointer-events: auto; background: var(--gold); color: black; border: none; padding: 14px 30px; border-radius: 30px; font-weight: bold; font-size: 16px; 
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.6); position: relative; overflow: hidden; min-width: 160px; transition: transform 0.2s, background 0.3s;
        }
        .btn:active { transform: scale(0.95); }
        .btn.counting { background: #222; color: var(--gold); border: 1px solid var(--gold); }
        .btn-progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(212, 175, 55, 0.15); width: 0%; pointer-events: none; }

        /* å»£å‘Šä½é ç•™ */
        #ad-slot { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background: #000; border-top: 1px solid #222; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #444; z-index: 50; letter-spacing: 1px; }

        /* éå ´å‹•ç•« */
        #transition-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .poem { font-size: 26px; color: var(--gold); letter-spacing: 10px; writing-mode: vertical-rl; opacity: 0; transition: opacity 1.5s; line-height: 1.6; text-shadow: 0 0 10px rgba(212,175,55,0.5); }

        /* é€šç”¨å½ˆçª— */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .msg { color: var(--gold); font-size: 20px; margin-bottom: 35px; line-height: 1.6; padding: 0 35px; }
        #skip-btn { background: transparent; border: 1px solid #333; color: #555; padding: 8px 18px; border-radius: 20px; font-size: 12px; margin-top: 20px; pointer-events: auto; display: none; }
    </style>
</head>
<body>

    <div id="age-gate">
        <div class="gate-box">
            <h1 style="color:var(--gold); font-size:26px; margin-bottom:10px;">æ˜¥é–¨æˆ²å¯†åœ–</h1>
            <p style="color:#888; font-size:14px; margin-bottom:30px;">æœ¬éŠæˆ²åŒ…å«æˆäººæ–‡æ¡ˆèˆ‡è¦ªå¯†äº’å‹•å»ºè­°<br>é€²å…¥å‰è«‹ç¢ºèªæ‚¨å·²å¹´æ»¿ 18 æ­²</p>
            <button class="btn" onclick="acceptAge()">æˆ‘å·²æ»¿ 18 æ­²</button>
        </div>
    </div>

    <div id="transition-overlay"><div id="poem-text" class="poem"></div></div>

    <div class="card-container" id="main-ui" onclick="handleFlip()">
        <div id="card-obj" class="card">
            <div id="card-front" class="face face-front"></div>
            <div id="card-back" class="face face-back"></div>
        </div>
        <div id="ui-layer" class="ui-layer">
            <button id="action-btn" class="btn" onclick="handleAction(event)">
                <div id="btn-progress" class="btn-progress"></div>
                <span id="btn-label">é»æ“Šæ“ä½œ</span>
            </button>
            <button id="skip-btn" onclick="forceNextStage(event)">æ…¾ç«å·²ç‡ƒï¼Œé€²å…¥ä¸‹ä¸€ç« </button>
        </div>
    </div>

    <div id="ad-slot">PROMOTED CONTENT / SPONSOR LINK</div>

    <div id="game-overlay" class="overlay" style="display:none;">
        <div id="overlay-msg" class="msg"></div>
        <div id="overlay-btns" style="display:flex; flex-direction:column; gap:15px;"></div>
    </div>

    <script>
        const ext = 'png';
        const diceData = { 1: [5, 10, 15, 20, 25, 30], 2: ["3æ¬¡", "5æ¬¡", "10æ¬¡", "15æ¬¡", "20æ¬¡", "30æ¬¡"] };
        const _m = "eyJsZXZlbDEiOlsiMDEtMSIsIjAyLTAiLCIwMy1vZmYtMCIsIjA0LTIiLCIwNS1vZmYtMCIsIjA2LTAiLCIwNy0xIiwiMDgtMiIsIjA5LW9mZi0wIiwiMTAtMSIsIjExLTIiLCIxMi0wIiwiMTMtb2ZmLTAiLCIxNC1vZmYtMCIsIjE1LTEiLCIxNi0xIiwiMTctMCIsIjE4LWxhc3QtMCIsIjE5LTIiLCIyMC1vZmYtMCJdLCJsZXZlbDIiOlsiMDEtMSIsIjAyLTEiLCIwMy0xIiwiMDQtMSIsIjA1LTEiLCIwNi0yIiwiMDctMSIsIjA4LTEiLCIwOS0xIiwiMTAtMiIsIjExLTIiLCIxMi0xIiwiMTMtMiIsIjE0LTIiLCIxNS0yIl0sInNleHVhbCI6WyIwMS0xIiwiMDItcy0wIiwiMDMtMSIsIjA0LW0tMCIsIjA1LTEiLCIwNi0xIiwiMDctcy0yIiwiMDgtMSIsIjA5LW0tMCIsIjEwLTEiLCIxMS1zLTAiLCIxMi1vdmVyLTAiXSwibWlzc2lvbiI6WyIwMS0wIiwiMDItMCIsIjAzLTEiLCIwNC0xIiwiMDUtMiIsIjA2LTIiLCIwNy0xIiwiMDgtMCIsIjA5LTEiLCIxMC0xIiwiMTEtMiIsIjEyLTEiLCIxMy0yIiwiMTQtMSIsIjE1LTEiLCIxNi0wIiwiMTctMCIsIjE4LTEiLCIxOS0xIiwiMjAtMCJdLCJzaGFtZSI6WyIwMS0wIiwiMDItMCIsIjAzLTAiLCIwNC0wIiwiMDUtMiIsIjA2LTAiLCIwNy0yIiwiMDgtMCIsIjA5LTAiLCIxMC0xIiwiMTEtMiIsIjEyLTAiLCIxMy0xIiwiMTQtMCIsIjE1LTEiLCIxNi0wIiwiMTctMSIsIjE4LTEiLCIxOS0yIiwiMjAtMCJdfQ==";
        let manifest = {};

        let state = {
            stage: 'level1', nextPool: 'level1', isFlipped: false,
            drawCount: 0, offCount: 0, sexualDraws: 0,
            isL2Extended: false, hasAskedQuick: false,
            currentCard: null, pools: {}, timer: null, timeLeft: 0
        };

        function acceptAge() {
            document.getElementById('age-gate').style.opacity = '0';
            setTimeout(() => { document.getElementById('age-gate').style.display = 'none'; initGame(); }, 600);
        }

        function initGame() {
            manifest = JSON.parse(atob(_m));
            Object.keys(manifest).forEach(k => { 
                state.pools[k] = [...manifest[k]].filter(f => !f.includes('last') && !f.includes('over')); 
            });
            document.getElementById('card-back').style.backgroundImage = `url('level1-cover.${ext}')`;
            document.getElementById('main-ui').style.opacity = '1';
        }

        function handleFlip() {
            if (state.isFlipped) return;

            // --- å„ªåŒ–é»ï¼šé å‘Šå„€å¼ ---
            if (state.stage === 'level2' && state.nextPool === 'level2') {
                const r = Math.random();
                if (r < 0.25) return triggerRitual('mission', 'ğŸ”¥ æŠ½ä¸­ï¼šæ˜¥å®®å¯†ä»¤', 'æ¥å—æŒ‘æˆ°å§ï¼');
                if (r < 0.50) return triggerRitual('shame', 'ğŸ˜³ æŠ½ä¸­ï¼šç¾æ¥ç¦ä»¤', 'æº–å‚™å¥½è‡‰ç´…å¿ƒè·³äº†å—ï¼Ÿ');
            }

            let poolKey = state.nextPool;
            let pool = state.pools[poolKey] || state.pools[state.stage];
            
            if (state.stage === 'level1') {
                let prob = state.drawCount < 5 ? 0.15 : (state.drawCount < 10 ? 0.30 : 0.50);
                if (state.drawCount >= 11 && state.offCount < 7) prob = 0.8;
                const type = Math.random() < prob ? 'off' : 'normal';
                const filtered = pool.filter(f => type === 'off' ? f.includes('off') : !f.includes('off'));
                pool = filtered.length > 0 ? filtered : pool;
            }

            const idx = Math.floor(Math.random() * pool.length);
            const cardData = pool.splice(idx, 1)[0];
            state.currentCard = { key: poolKey, info: cardData };
            state.drawCount++;
            if (cardData.includes('off')) state.offCount++;

            document.getElementById('card-front').style.backgroundImage = `url('${poolKey}-${cardData}.${ext}')`;
            document.getElementById('card-obj').classList.add('is-flipped');
            state.isFlipped = true;

            setTimeout(() => {
                document.getElementById('ui-layer').style.display = 'flex';
                const type = cardData.split('-').pop();
                if (type === '0') updateBtnLabel("å®Œæˆä»»å‹™");
                else updateBtnLabel("é»æ“Šæ“²éª°");
                if (state.stage === 'level2' && state.drawCount >= 10) document.getElementById('skip-btn').style.display = 'block';
            }, 600);
        }

        // å„€å¼å°ˆç”¨ï¼šå°é¢æ»‘å…¥
        function triggerRitual(target, title, msg) {
            showOverlay(`${title}<br><small>${msg}</small>`, [{ 
                text: "æ¥å—æŒ‘æˆ°", 
                action: () => {
                    hideOverlay();
                    const back = document.getElementById('card-back');
                    back.classList.remove('slide-in');
                    void back.offsetWidth; // å¼·åˆ¶é‡ç¹ª
                    state.nextPool = target;
                    back.style.backgroundImage = `url('${target}-cover.${ext}')`;
                    back.classList.add('slide-in');
                }
            }]);
        }

        function handleAction(e) {
            e.stopPropagation();
            if (state.timer) { stopTimer(); return; } 
            const label = document.getElementById('btn-label').innerText;
            const type = state.currentCard.info.split('-').pop();

            if (label === "é»æ“Šæ“²éª°") {
                const res = diceData[type][Math.floor(Math.random() * 6)];
                if (type === '1') { state.timeLeft = res; updateBtnLabel(`é–‹å§‹è¨ˆæ™‚ (${res}ç§’)`); }
                else { updateBtnLabel(`å®Œæˆä»»å‹™ (${res})`); }
            } else if (label.includes("é–‹å§‹è¨ˆæ™‚")) {
                startTimer();
            } else if (label.includes("å®Œæˆä»»å‹™")) {
                // --- å„ªåŒ–é»ï¼šç•™ç™½é¤˜éŸ» ---
                // å…ˆç¿»å›å»ï¼Œç­‰å‹•ç•«çµæŸæ‰æª¢æŸ¥é€²åº¦
                document.getElementById('card-obj').classList.remove('is-flipped');
                document.getElementById('ui-layer').style.display = 'none';
                state.isFlipped = false;
                
                setTimeout(() => {
                    // ç¿»å®Œå¾Œï¼Œæª¢æŸ¥æ˜¯å¦é€£é–æˆ–è½‰å ´
                    if (state.currentCard.info.includes('-s-')) return triggerRitual('shame', 'é€£é–ï¼šç¾æ¥ç¦ä»¤', 'ä¸è¦åœ...');
                    if (state.currentCard.info.includes('-m-')) return triggerRitual('mission', 'é€£é–ï¼šæ˜¥å®®å¯†ä»¤', 'åŠ ç¢¼æŒ‘æˆ°ï¼');
                    checkGameProgress();
                }, 600);
            }
        }

        function checkGameProgress() {
            // Level 1 å¿«é€Ÿå¿«é€²
            if (state.stage === 'level1' && state.drawCount === 6 && !state.hasAskedQuick) {
                state.hasAskedQuick = true;
                return showOverlay("çœ‹è‘—å½¼æ­¤ï¼Œæ˜¯å¦å·²å¿ƒç™¢é›£è€ï¼Ÿ", [
                    { text: "è¿«ä¸åŠå¾…å¦èª ç›¸è¦‹", action: () => forceNextStage() },
                    { text: "æˆ‘å€‘æƒ³æ…¢æ…¢ä¾†", action: () => resetCard() }
                ]);
            }
            // éšæ®µä¸€çµæŸ
            if (state.stage === 'level1' && (state.offCount >= 7 || state.drawCount >= 13)) {
                return playTransition("é›²æƒ³è¡£è£³èŠ±æƒ³å®¹ï¼Œ<br>æ˜¥é¢¨æ‹‚æª»éœ²è¯æ¿ƒã€‚", "level2");
            }
            // éšæ®µäºŒé€²åº¦
            if (state.stage === 'level2') {
                const limit = state.isL2Extended ? 20 : 14;
                if (state.drawCount >= limit) {
                    if (!state.isL2Extended) {
                        return showOverlay("æƒ…æ…¾å·²ç„¶æ²¸é¨°...", [
                            { text: "é€²å…¥é›²é›¨äº¤æ­¡", action: () => playTransition("é‡‘é¢¨ç‰éœ²ä¸€ç›¸é€¢ï¼Œ<br>ä¾¿å‹å»äººé–“ç„¡æ•¸ã€‚", "sexual") },
                            { text: "æ„çŒ¶æœªç›¡(è¿½åŠ 6æŠ½)", action: () => { state.isL2Extended = true; resetCard(); } }
                        ]);
                    } else { return playTransition("é‡‘é¢¨ç‰éœ²ä¸€ç›¸é€¢ï¼Œ<br>ä¾¿å‹å»äººé–“ç„¡æ•¸ã€‚", "sexual"); }
                }
            }
            // éŠæˆ²çµ‚çµ
            if (state.stage === 'sexual') {
                state.sexualDraws++;
                if (state.sexualDraws >= 7 || state.currentCard.info.includes('over')) {
                    return showOverlay("é›²é›¨æ—¢çµ‚ï¼Œè‰¯å®µæš«æ­‡", [{ text: "é‡å•ŸéŠæˆ²", action: () => location.reload() }]);
                }
            }
            resetCard();
        }

        function resetCard() {
            hideOverlay();
            if (state.stage === 'level2') {
                const r = Math.random();
                state.nextPool = r < 0.25 ? 'mission' : (r < 0.5 ? 'shame' : 'level2');
            } else { state.nextPool = state.stage; }
            setTimeout(() => { document.getElementById('card-back').style.backgroundImage = `url('${state.nextPool}-cover.${ext}')`; }, 100);
        }

        // --- ä»¥ä¸‹é‚è¼¯ä¿æŒä¸è®Š ---
        function startTimer() {
            const btn = document.getElementById('action-btn');
            const progress = document.getElementById('btn-progress');
            const total = state.timeLeft;
            btn.classList.add('counting');
            updateBtnLabel(`å‰©é¤˜ ${state.timeLeft} ç§’`);
            progress.style.transition = 'none';
            progress.style.width = '100%';
            setTimeout(() => { progress.style.transition = `width ${total}s linear`; progress.style.width = '0%'; }, 50);
            state.timer = setInterval(() => {
                state.timeLeft--;
                if (state.timeLeft > 0) updateBtnLabel(`å‰©é¤˜ ${state.timeLeft} ç§’`);
                else { stopTimer(); if (navigator.vibrate) navigator.vibrate([100, 50, 100]); }
            }, 1000);
        }
        function stopTimer() { clearInterval(state.timer); state.timer = null; document.getElementById('action-btn').classList.remove('counting'); document.getElementById('btn-progress').style.width = '0%'; updateBtnLabel("å®Œæˆä»»å‹™"); }
        function updateBtnLabel(txt) { document.getElementById('btn-label').innerText = txt; }
        function playTransition(text, nextStage) {
            hideOverlay();
            const ov = document.getElementById('transition-overlay');
            const p = document.getElementById('poem-text');
            ov.style.display = 'flex';
            setTimeout(() => { p.innerHTML = text; p.style.opacity = 1; }, 100);
            setTimeout(() => {
                p.style.opacity = 0;
                setTimeout(() => {
                    ov.style.display = 'none';
                    state.stage = nextStage; state.nextPool = nextStage;
                    state.drawCount = 0; state.offCount = 0; state.isL2Extended = false;
                    document.getElementById('skip-btn').style.display = 'none';
                    resetCard();
                }, 1000);
            }, 3000);
        }
        function forceNextStage(e) { if(e) e.stopPropagation(); playTransition(state.stage === 'level1' ? "æ˜¥è‰²æ»¿åœ’é—œä¸ä½..." : "å…±èµ´å·«å±±é›²é›¨...", state.stage === 'level1' ? 'level2' : 'sexual'); }
        function showOverlay(msg, btns) {
            const o = document.getElementById('game-overlay');
            document.getElementById('overlay-msg').innerHTML = msg;
            const c = document.getElementById('overlay-btns'); c.innerHTML = '';
            btns.forEach(b => {
                const el = document.createElement('button'); el.className = 'btn'; el.innerText = b.text; el.onclick = b.action; c.appendChild(el);
            });
            o.style.display = 'flex';
        }
        function hideOverlay() { document.getElementById('game-overlay').style.display = 'none'; }
    </script>
</body>
</html>