<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜¥é–¨æˆ²å¯†åœ– | å¤é¢¨æƒ…è¶£å¡ç‰Œ</title>
    <style>
        :root { --gold: #d4af37; --bg: #0a0a0a; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Noto Serif TC', serif, "Apple Color Emoji", "Segoe UI Emoji"; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 15px 0; }

        .top-tools { position: fixed; top: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; z-index: 600; }
        .tool-btn { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; color: var(--gold); cursor: pointer; font-size: 22px; text-shadow: 0 0 8px rgba(212, 175, 55, 0.5); }

        #stage-header { color: var(--gold); font-size: 18px; letter-spacing: 2px; height: 30px; margin-top: 15px; }

        .card-container { position: relative; height: 72vh; aspect-ratio: 472 / 945; perspective: 1200px; margin: 0 auto; }
        .card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .card.is-flipped { transform: rotateY(180deg); }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background-size: cover; background-position: center; border-radius: 15px; border: 1px solid rgba(212, 175, 55, 0.3); }
        .face-front { transform: rotateY(180deg); }

        .controls-layer { width: 100%; height: 110px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .btn { background: var(--gold); color: black; border: none; padding: 12px 28px; border-radius: 25px; font-weight: bold; font-size: 16px; cursor: pointer; min-width: 160px; }
        .btn.counting { background: #222; color: var(--gold); border: 1px solid var(--gold); }
        .btn-progress { position: absolute; right: 0; top: 0; height: 100%; background: rgba(212, 175, 55, 0.25); width: 0%; pointer-events: none; }
        
        #dice-text { color: var(--gold); font-size: 24px; font-weight: bold; height: 32px; margin-bottom: 5px; }
        #skip-btn { background: transparent; border: 1px solid #444; color: #666; padding: 5px 12px; border-radius: 20px; font-size: 11px; margin-top: 5px; display: none; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .gate-box { padding: 30px; border: 1px solid var(--gold); background: #0d0d0d; border-radius: 20px; width: 85%; max-width: 400px; }
        #transition-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .poem { font-size: 24px; color: var(--gold); letter-spacing: 8px; writing-mode: vertical-rl; opacity: 0; transition: opacity 1.5s; }
    </style>
</head>
<body>

    <div class="top-tools">
        <div class="tool-btn" onclick="showInfo()">&#x2139;&#xFE0E;</div>
        <div id="mute-btn" class="tool-btn" onclick="toggleMute()">&#x1F514;&#xFE0E;</div>
    </div>

    <div id="stage-header">ç¬¬ä¸€ç«  è©¦æ¢æ˜¥å¿ƒ</div>

    <div class="card-container" onclick="handleFlip()">
        <div id="card-obj" class="card">
            <div id="card-front" class="face face-front"></div>
            <div id="card-back" class="face face-back"></div>
        </div>
    </div>

    <div class="controls-layer">
        <div id="dice-text"></div>
        <div id="action-area" style="display:none;">
            <button id="action-btn" class="btn" onclick="handleAction(event)">
                <div id="btn-progress" class="btn-progress"></div>
                <span id="btn-label"></span>
            </button>
        </div>
        <button id="skip-btn" onclick="forceNextStage(event)">æ…¾ç«å·²ç‡ƒï¼Œé€²å…¥ä¸‹ä¸€ç« </button>
    </div>

    <div id="age-gate" class="overlay">
        <div class="gate-box">
            <h2 style="color:var(--gold);">æ˜¥é–¨æˆ²å¯†åœ–</h2>
            <p style="color:#ccc; font-size: 14px; margin-bottom: 25px;">æœ¬éŠæˆ²åŒ…å«æˆäººæ–‡æ¡ˆå…§å®¹èˆ‡è‚¢é«”æŒ‡ä»¤ï¼Œ<br>åƒ…ä¾›æˆå¹´ä¼´ä¾¶æƒ…è¶£äº’å‹•ä½¿ç”¨ã€‚<br>é€²å…¥å‰è«‹ç¢ºèªæ‚¨å·²å¹´æ»¿ 18 æ­²ã€‚</p>
            <button class="btn" onclick="acceptAge()">æˆ‘å·²æ»¿ 18 æ­²</button>
        </div>
    </div>

    <div id="info-overlay" class="overlay" style="display:none;" onclick="this.style.display='none'">
        <div class="gate-box">
            <h3 style="color:var(--gold);">éŠç©æŒ‡å—</h3>
            <p style="text-align:left; font-size:14px; color:#ccc; line-height: 2;">
                â— é»æ“Šå¡ç‰‡ç¿»é–‹æŒ‡ä»¤ã€‚<br>
                â— éš¨æ©Ÿå‡ºç¾ã€Œæ˜¥å®®å¯†ä»¤ã€èˆ‡ã€Œç¾æ¥ç¦ä»¤ã€ã€‚
            </p>
            <button class="btn" onclick="document.getElementById('info-overlay').style.display='none'">äº†è§£</button>
        </div>
    </div>

    <div id="game-overlay" class="overlay" style="display:none;">
        <div id="overlay-msg" style="color:var(--gold); margin-bottom:25px; font-size: 20px;"></div>
        <div id="overlay-btns" style="display:flex; flex-direction:column; gap:15px; align-items:center;"></div>
    </div>

    <div id="transition-overlay"><div id="poem-text" class="poem"></div></div>

    <script>
        const ext = 'png';
        const timerAudio = new Audio('timer-end.mp3');
        const flipAudio = new Audio('card-flip.mp3');
        const diceData = { 1: [5, 10, 15, 20, 25, 30], 2: ["3æ¬¡", "5æ¬¡", "10æ¬¡", "15æ¬¡", "20æ¬¡", "30æ¬¡"] };
        const manifest = {
            level1: ["01-1", "02-0", "03-off-0", "04-2", "05-off-0", "06-0", "07-1", "08-2", "09-off-0", "10-1", "11-2", "12-0", "13-off-0", "14-off-0", "15-1", "16-1", "17-0", "18-last-0", "19-2", "20-off-0"],
            level2: ["01-1", "02-1", "03-1", "04-1", "05-1", "06-2", "07-1", "08-1", "09-1", "10-2", "11-2", "12-1", "13-2", "14-2", "15-2"],
            sexual: ["01-1", "02-s-0", "03-1", "04-m-0", "05-1", "06-1", "07-s-2", "08-1", "09-m-0", "10-1", "11-s-0", "12-over-0"],
            mission: ["01-0", "02-0", "03-1", "04-1", "05-2", "06-2", "07-1", "08-0", "09-1", "10-1", "11-2", "12-1", "13-2", "14-1", "15-1", "16-0", "17-0", "18-1", "19-1", "20-0"],
            shame: ["01-0", "02-0", "03-0", "04-0", "05-2", "06-0", "07-2", "08-0", "09-0", "10-1", "11-2", "12-0", "13-1", "14-0", "15-1", "16-0", "17-1", "18-1", "19-2", "20-0"]
        };

        let state = { stage: 'level1', nextPool: 'level1', isFlipped: false, drawCount: 0, offCount: 0, isMuted: false, timer: null, pools: {}, isExtraPending: false };

        function acceptAge() {
            [timerAudio, flipAudio].forEach(a => { a.play().then(()=>a.pause()).catch(()=>{}) });
            document.getElementById('age-gate').style.display = 'none';
            initGame();
        }

        function initGame() {
            Object.keys(manifest).forEach(k => { state.pools[k] = [...manifest[k]].filter(f => !f.includes('last') && !f.includes('over')); });
            updateHeader();
            document.getElementById('card-back').style.backgroundImage = `url('level1-cover.${ext}')`;
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            document.getElementById('mute-btn').innerHTML = state.isMuted ? "&#x1F515;&#xFE0E;" : "&#x1F514;&#xFE0E;";
        }

        function handleFlip() {
            if (state.isFlipped) return;

            // 1. æª¢æŸ¥æ˜¯å¦è¦è§¸ç™¼ã€Œéš¨æ©ŸæŒ‘æˆ°å½ˆçª—ã€
            // æ¢ä»¶ï¼šåœ¨ç¬¬äºŒç« ã€ä¸”ç›®å‰ä¸æ˜¯åœ¨æŠ½æŒ‘æˆ°å¡æ± ã€ä¸”å°šæœªæ¨™è¨˜è¦åŸ·è¡ŒæŒ‘æˆ°
            if (state.stage === 'level2' && state.nextPool === 'level2' && !state.isExtraPending) {
                if (Math.random() < 0.25) { // 25% æ©Ÿç‡è§¸ç™¼
                    state.isExtraPending = true; // é–å®šç‹€æ…‹ï¼Œé˜²æ­¢é‡è¤‡åˆ¤å®š
                    const target = Math.random() < 0.5 ? 'mission' : 'shame';
                    triggerExtra(target, target==='mission'?'ğŸ”¥ æŠ½ä¸­ï¼šæ˜¥å®®å¯†ä»¤':'ğŸ˜³ æŠ½ä¸­ï¼šç¾æ¥ç¦ä»¤', 'æ¥å—æŒ‘æˆ°');
                    return;
                }
            }

            // 2. æ­£å¸¸ç¿»ç‰Œé‚è¼¯
            if (!state.isMuted) flipAudio.play();

            let poolKey = state.nextPool;
            let pool = state.pools[poolKey];
            
            // éš¨æ©Ÿé¸ä¸€å¼µ
            const idx = Math.floor(Math.random() * pool.length);
            const cardData = pool.splice(idx, 1)[0];
            state.currentCard = { key: poolKey, info: cardData };
            
            // çµ±è¨ˆ
            state.drawCount++;
            if (cardData.includes('off')) state.offCount++;

            // æ›´æ–°åœ–ç‰‡èˆ‡ç¿»è½‰
            document.getElementById('card-front').style.backgroundImage = `url('${poolKey}-${cardData}.${ext}')`;
            document.getElementById('card-obj').classList.add('is-flipped');
            state.isFlipped = true;

            setTimeout(() => {
                document.getElementById('action-area').style.display = 'block';
                const type = cardData.split('-').pop();
                updateBtnLabel(type === '0' ? "å®Œæˆä»»å‹™" : "é»æ“Šæ“²éª°");
                if (state.stage === 'level2' && state.drawCount >= 10) document.getElementById('skip-btn').style.display = 'block';
            }, 600);
        }

        function triggerExtra(target, title, btnText) {
            showOverlay(title, [{ text: btnText, action: () => {
                state.nextPool = target; 
                // æ›å°é¢ï¼Œé€™æ™‚ä½¿ç”¨è€…çœ‹åˆ°å°é¢æ›äº†ï¼Œæœƒæƒ³é»æ“Š
                document.getElementById('card-back').style.backgroundImage = `url('${target}-cover.${ext}')`;
                hideOverlay();
                // æ³¨æ„ï¼šé€™è£¡ä¸ä¸»å‹• handleFlipï¼Œè®“ä½¿ç”¨è€…æ‰‹å‹•é»æ“Šé‚£å¼µã€Œæ–°å°é¢çš„å¡ã€
            }}]);
        }

        function checkGameProgress() {
            // ç¬¬ä¸€ç« çµæŸåˆ¤æ–·
            if (state.stage === 'level1' && (state.offCount >= 7 || state.drawCount >= 12)) {
                return playTransition("é›²æƒ³è¡£è£³èŠ±æƒ³å®¹ï¼Œ<br>æ˜¥é¢¨æ‹‚æª»éœ²è¯æ¿ƒã€‚", "level2");
            }
            // ç¬¬äºŒç« çµæŸåˆ¤æ–·
            if (state.stage === 'level2' && state.drawCount >= 14 && !state.isL2Extended) {
                return showOverlay("æƒ…æ…¾å·²ç„¶æ²¸é¨°...", [
                    { text: "é€²å…¥é›²é›¨äº¤æ­¡", action: () => playTransition("é‡‘é¢¨ç‰éœ²ä¸€ç›¸é€¢ï¼Œ<br>ä¾¿å‹å»äººé–“ç„¡æ•¸ã€‚", "sexual") },
                    { text: "æ„çŒ¶æœªç›¡(+6æŠ½)", action: () => { state.isL2Extended = true; resetCard(); } }
                ]);
            }
            // ç¬¬ä¸‰ç« çµæŸ
            if (state.stage === 'sexual' && state.drawCount >= 7) {
                const finalMsg = "çºç¶¿æ‚±æƒ»ï¼Œæ˜¥å…‰ç„¡é™<br><small>ç›¡æƒ…æ²‰é†‰æ–¼äº¤æ­¡ä¹‹æ¨‚</small><br><br><span style='font-size:14px; color:#888;'>ç‚ºä¸‹æ¬¡çš„ç¾å¥½æ™‚å…‰åšæº–å‚™ï¼Ÿ</span><br><a href='https://your-ad-link.com' class='ad-link' target='_blank'>æŸ¥çœ‹ Blanc ç²¾é¸æƒ…è¶£é¸ç‰©</a>";
                return showOverlay(finalMsg, [{ text: "è‰¯å®µå†çºŒ (é‡æ–°é–‹å§‹)", action: () => location.reload() }]);
            }
            resetCard();
        }

        function resetCard() {
            document.getElementById('card-obj').classList.remove('is-flipped');
            document.getElementById('action-area').style.display = 'none';
            document.getElementById('dice-text').innerText = '';
            state.isFlipped = false;
            state.isExtraPending = false; // è§£é–æŒ‘æˆ°åˆ¤å®š
            hideOverlay();
            
            setTimeout(() => {
                // å¦‚æœå‰›æ‰æŠ½çš„æ˜¯æŒ‘æˆ°å¡æ± ï¼ŒæŠ½å®Œå¾Œè¦åˆ‡æ›å›ä¸»ç« ç¯€
                if (state.nextPool === 'mission' || state.nextPool === 'shame') {
                    state.nextPool = state.stage;
                }
                document.getElementById('card-back').style.backgroundImage = `url('${state.nextPool}-cover.${ext}')`;
            }, 300);
        }

        function updateHeader() {
            const titles = { 'level1': 'ç¬¬ä¸€ç«  è©¦æ¢æ˜¥å¿ƒ', 'level2': 'ç¬¬äºŒç«  å¸³æš–æ˜¥é¢¨', 'sexual': 'ç¬¬ä¸‰ç«  é›²é›¨äº¤æ­¡' };
            document.getElementById('stage-header').innerText = titles[state.stage];
        }

        function playTransition(text, nextStage) {
            const ov = document.getElementById('transition-overlay');
            const p = document.getElementById('poem-text');
            ov.style.display = 'flex';
            setTimeout(() => { p.innerHTML = text; p.style.opacity = 1; }, 100);
            setTimeout(() => {
                p.style.opacity = 0;
                setTimeout(() => {
                    ov.style.display = 'none';
                    state.stage = nextStage; state.nextPool = nextStage;
                    state.drawCount = 0; state.offCount = 0;
                    updateHeader();
                    resetCard();
                }, 1000);
            }, 3000);
        }

        function showInfo() { document.getElementById('info-overlay').style.display = 'flex'; }
        function updateBtnLabel(txt) { document.getElementById('btn-label').innerText = txt; }
        
        function handleAction(e) {
            e.stopPropagation();
            const label = document.getElementById('btn-label').innerText;
            const type = state.currentCard.info.split('-').pop();

            if (label === "é»æ“Šæ“²éª°") {
                const res = diceData[type][Math.floor(Math.random() * 6)];
                document.getElementById('dice-text').innerText = (type === '1' ? res + " ç§’" : res);
                updateBtnLabel("å®Œæˆä»»å‹™");
            } else {
                checkGameProgress();
            }
        }

        function showOverlay(msg, btns) {
            const o = document.getElementById('game-overlay');
            document.getElementById('overlay-msg').innerHTML = msg;
            const c = document.getElementById('overlay-btns'); c.innerHTML = '';
            btns.forEach(b => {
                const el = document.createElement('button'); el.className = 'btn'; el.innerText = b.text; el.onclick = b.action; c.appendChild(el);
            });
            o.style.display = 'flex';
        }
        function hideOverlay() { document.getElementById('game-overlay').style.display = 'none'; }
        function forceNextStage(e) { e.stopPropagation(); playTransition("æ˜¥æƒ…é›£é...", state.stage === 'level1' ? 'level2' : 'sexual'); }
    </script>
</body>
</html>

